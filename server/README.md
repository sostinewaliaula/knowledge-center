# Knowledge Center Backend API

## Setup Instructions

### 1. Install Dependencies

```bash
cd server
npm install
```

### 2. Configure Environment

The `.env` file is already created with your database credentials:
- DB_HOST=localhost
- DB_USER=root
- DB_PASSWORD=mctm3223
- DB_NAME=kc
- JWT_SECRET=kc-secret-key-2024-production
- PORT=3000

### 3. Initialize Database

**Recommended: Use SQL Migrations** (better for version control and team collaboration)

```bash
npm run migrate
```

This will run all pending SQL migrations from the `migrations/` directory.

**Alternative: Use initialization scripts** (for one-time setup or data migrations)

```bash
npm run init-db
```

**Important**: 
- **Use SQL migrations for schema changes** - See [migrations/README.md](./migrations/README.md)
- **All tables use UUID for primary keys** (more secure than auto-incrementing integers)
- **All ID columns have `DEFAULT (UUID())`** - UUIDs are automatically generated by the database
- To migrate existing INT IDs to UUIDs, use: `npm run migrate-uuid` (⚠️ **WARNING**: This will convert all IDs. Backup your data first!)

**Check migration status:**
```bash
npm run migrate-status
```

This will create:
- `roles` table (for role management)
- `role_permissions` table (for future permission management)
- `users` table (with role_id foreign key)
- `otp_codes` table (for password reset OTPs)
- `password_resets` table (for password reset tokens)

Default roles created:
- **admin** - Administrator (Full system access)
- **learner** - Learner (Access to learning content)
- **instructor** - Instructor (Can create and manage courses)
- **auditor** - Auditor (Read-only access for auditing)

### 4. Create Test Users

Create a single test user:
```bash
npm run create-test-user
```
- Email: test@caavagroup.com
- Password: Test1234
- Role: learner

Create users for all roles:
```bash
npm run create-all-users
```
This creates:
- **admin@caavagroup.com** / Admin1234 (Administrator)
- **learner@caavagroup.com** / Learner1234 (Learner)
- **instructor@caavagroup.com** / Instructor1234 (Instructor)
- **auditor@caavagroup.com** / Auditor1234 (Auditor)

### 5. Start the Server

Development mode (with auto-reload):
```bash
npm run dev
```

Production mode:
```bash
npm start
```

The server will run on `http://localhost:3000`

## API Endpoints

### Authentication

- `POST /api/auth/login` - User login
  - Body: `{ email, password }`
  - Returns: `{ success, token, user }`

- `POST /api/auth/forgot-password` - Send OTP for password reset
  - Body: `{ email }`
  - Returns: `{ success, message, otp }` (otp only in development)

- `POST /api/auth/verify-otp` - Verify OTP code
  - Body: `{ email, otp }`
  - Returns: `{ success, message }`

- `POST /api/auth/reset-password` - Reset password with OTP
  - Body: `{ email, otp, newPassword }`
  - Returns: `{ success, message }`

### Roles Management

- `GET /api/roles` - Get all roles
  - Returns: `{ success, roles }`

- `GET /api/roles/:id` - Get single role
  - Returns: `{ success, role }`

- `POST /api/roles` - Create new custom role (admin only)
  - Body: `{ name, display_name, description }`
  - Returns: `{ success, role }`

- `PUT /api/roles/:id` - Update role (admin only)
  - Body: `{ display_name, description }`
  - Returns: `{ success, role }`

- `DELETE /api/roles/:id` - Delete custom role (admin only)
  - Returns: `{ success, message }`

### Health Check

- `GET /api/health` - Check if API is running

## Database Schema

### roles
- id (INT, PRIMARY KEY, AUTO_INCREMENT)
- name (VARCHAR(50), UNIQUE, NOT NULL)
- display_name (VARCHAR(100), NOT NULL)
- description (TEXT)
- is_system_role (BOOLEAN, DEFAULT FALSE)
- created_at (TIMESTAMP)
- updated_at (TIMESTAMP)

### users
- id (INT, PRIMARY KEY, AUTO_INCREMENT)
- email (VARCHAR(255), UNIQUE, NOT NULL)
- password (VARCHAR(255), NOT NULL) - bcrypt hashed
- name (VARCHAR(255))
- role_id (INT, FOREIGN KEY -> roles.id)
- created_at (TIMESTAMP)
- updated_at (TIMESTAMP)

### role_permissions
- id (INT, PRIMARY KEY, AUTO_INCREMENT)
- role_id (INT, FOREIGN KEY -> roles.id)
- permission (VARCHAR(100), NOT NULL)
- created_at (TIMESTAMP)

### otp_codes
- id (INT, PRIMARY KEY, AUTO_INCREMENT)
- email (VARCHAR(255), NOT NULL)
- code (VARCHAR(6), NOT NULL)
- expires_at (TIMESTAMP, NOT NULL)
- used (BOOLEAN, DEFAULT FALSE)
- created_at (TIMESTAMP)

### password_resets
- id (INT, PRIMARY KEY, AUTO_INCREMENT)
- email (VARCHAR(255), NOT NULL)
- token (VARCHAR(255), NOT NULL)
- expires_at (TIMESTAMP, NOT NULL)
- used (BOOLEAN, DEFAULT FALSE)
- created_at (TIMESTAMP)

## Role System

The system supports:
- **System Roles** (cannot be deleted or renamed):
  - admin
  - learner
  - instructor
  - auditor

- **Custom Roles** (can be added, modified, and deleted via admin panel):
  - Can be created through the API
  - Can be assigned to users
  - Can have custom permissions (future feature)

## Notes

- OTP codes expire after 10 minutes
- In development mode, OTP is returned in the API response for testing
- Passwords are hashed using bcrypt
- JWT tokens expire after 7 days
- System roles cannot be deleted or have their names changed
- Custom roles can be fully managed through the admin interface
